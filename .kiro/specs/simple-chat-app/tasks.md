# Implementation Plan

## タスク概要

本ドキュメントは、シンプルなチャットアプリケーションの実装タスクを定義します。すべてのタスクは要件とコンポーネント設計に基づいて作成されており、段階的かつ統合的に実装を進めることができます。

---

## タスクリスト

### Phase 1: プロジェクトセットアップとインフラストラクチャ

- [ ] 1. プロジェクトの初期化と開発環境のセットアップ
- [ ] 1.1 (P) バックエンドプロジェクトの初期化
  - Node.js 20.x LTS + TypeScriptでプロジェクトを作成
  - Express、Prisma、Socket.io、bcrypt、jsonwebtokenなどの依存関係をインストール
  - ESLintとPrettierで型安全性とコード品質を確保
  - _Requirements: なし（セットアップタスク）_

- [ ] 1.2 (P) フロントエンドプロジェクトの初期化
  - React 18.x + TypeScript + Viteでプロジェクトを作成
  - Zustand、TailwindCSS、Socket.io Client、React Routerなどの依存関係をインストール
  - ESLintとPrettierで型安全性とコード品質を確保
  - _Requirements: なし（セットアップタスク）_

- [ ] 1.3 データベースのセットアップとスキーマ定義
  - PostgreSQL 16.xをDocker Composeで構成
  - Prismaスキーマを定義（users、rooms、messages、room_membersテーブル）
  - マイグレーションを実行してデータベースを初期化
  - インデックス戦略を適用（idx_messages_room_id_created_at、idx_users_emailなど）
  - _Requirements: 1.1, 1.5, 2.4, 2.5, 4.5, 6.4_

- [ ] 1.4 (P) Docker ComposeでフルスタックEコンテナを構成
  - バックエンド、フロントエンド、PostgreSQLの各コンテナを定義
  - 環境変数（DATABASE_URL、JWT_SECRET等）を.envファイルで管理
  - ホットリロードを有効化して開発体験を向上
  - _Requirements: なし（セットアップタスク）_

---

### Phase 2: 認証システムの実装

- [ ] 2. ユーザー認証機能の実装
- [ ] 2.1 AuthServiceの実装
  - ユーザー登録機能（パスワードハッシュ化、重複チェック）を実装
  - ログイン機能（JWT生成、HttpOnly Cookie設定）を実装
  - ログアウト機能（セッション終了）を実装
  - トークンリフレッシュ機能（Refresh Token検証、新規トークン発行）を実装
  - トークン検証機能（Access Token検証、有効期限チェック）を実装
  - bcryptでパスワードをハッシュ化（コスト12）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 2.2 認証APIエンドポイントの実装
  - POST /api/auth/register（新規登録）を実装
  - POST /api/auth/login（ログイン）を実装
  - POST /api/auth/logout（ログアウト）を実装
  - POST /api/auth/refresh（トークンリフレッシュ）を実装
  - express-validatorで入力バリデーションを実施
  - Helmet.jsでセキュリティヘッダーを設定（CSP、HSTS）
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 2.3 認証ミドルウェアの実装
  - JWTトークン検証ミドルウェアを実装
  - HttpOnly CookieからトークンSECを抽出
  - トークンが無効または期限切れの場合は401エラーを返却
  - 認証済みユーザー情報をリクエストオブジェクトに追加
  - _Requirements: 1.2, 1.3, 1.4_

- [ ] 2.4* 認証機能のユニットテストを作成
  - AuthService.register、login、verifyAccessTokenのテストを作成
  - パスワードハッシュ化、ユーザー重複チェック、トークン検証をテスト
  - Jest + ts-jestでテストを実行
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

---

### Phase 3: メッセージング機能の実装

- [ ] 3. メッセージ送受信機能の実装
- [ ] 3.1 MessageServiceの実装
  - メッセージ送信機能（DB永続化のみ）を実装
  - メッセージ履歴取得機能（カーソルベースページネーション）を実装
  - メッセージID取得機能を実装
  - XSS対策（HTMLエスケープ）を実施
  - タイムスタンプと送信者識別情報を自動付与
  - _Requirements: 2.1, 2.2, 2.4, 2.5, 3.3, 3.4, 6.1, 6.2, 6.3, 6.4_

- [ ] 3.2 メッセージAPIエンドポイントの実装
  - GET /api/messages（メッセージ履歴取得）を実装
  - GET /api/messages/:id（個別メッセージ取得）を実装
  - 認証ミドルウェアを適用してアクセス制御
  - クエリパラメータ（roomId、limit、before）をバリデーション
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 3.3 SocketServerの初期実装とメッセージ配信
  - Socket.ioサーバーを初期化（Express HTTPサーバーと統合）
  - WebSocket認証ミドルウェアを実装（HandshakeからHttpOnly Cookieを抽出してJWT検証）
  - クエリパラメータでのトークン送信を禁止
  - ルーム参加・退出機能を実装（socket.join、socket.leave）
  - message:sendイベントのハンドラを実装（MessageServiceを呼び出し、成功時にブロードキャスト）
  - message:receiveイベントをルーム内の全クライアントに配信（ベストエフォート）
  - 接続・切断イベントのログ記録
  - _Requirements: 2.1, 3.1, 7.1, 7.4_

- [ ] 3.4* メッセージ機能の統合テストを作成
  - メッセージ送信 → WebSocket配信 → データベース保存の統合テストを作成
  - Socket.io Clientを使用してエンドツーエンドのフローをテスト
  - Supertestでメッセージ履歴取得APIをテスト
  - _Requirements: 2.1, 3.1, 6.1_

---

### Phase 4: チャットルーム機能の実装

- [ ] 4. チャットルーム管理機能の実装
- [ ] 4.1 RoomServiceの実装
  - ルーム作成機能（作成者を自動的にメンバーに追加）を実装
  - ルーム一覧取得機能を実装
  - ルーム詳細取得機能を実装
  - ルーム参加機能（room_membersテーブルに追加）を実装
  - ルーム退出機能（room_membersテーブルから削除）を実装
  - ルームメンバー一覧取得機能を実装
  - トランザクション境界を適切に設定（ルーム作成時）
  - _Requirements: 4.1, 4.2, 4.4, 4.5_

- [ ] 4.2 ルーム管理APIエンドポイントの実装
  - POST /api/rooms（ルーム作成）を実装
  - GET /api/rooms（ルーム一覧取得）を実装
  - GET /api/rooms/:id（ルーム詳細取得）を実装
  - POST /api/rooms/:id/join（ルーム参加）を実装
  - POST /api/rooms/:id/leave（ルーム退出）を実装
  - GET /api/rooms/:id/members（メンバー一覧取得）を実装
  - 認証ミドルウェアを適用してアクセス制御
  - _Requirements: 4.1, 4.2, 4.4_

- [ ] 4.3 SocketServerにルーム参加通知機能を追加
  - room:joinイベントのハンドラを実装（RoomServiceを呼び出し）
  - room:user-joinedイベントをルーム内の全クライアントにブロードキャスト
  - room:leaveイベントのハンドラを実装
  - room:user-leftイベントをルーム内の全クライアントにブロードキャスト
  - _Requirements: 4.3_

- [ ] 4.4* ルーム機能の統合テストを作成
  - ルーム作成 → 参加 → メンバー通知の統合テストを作成
  - Socket.io Clientを使用してルーム参加通知をテスト
  - SupertestでルームAPIエンドポイントをテスト
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

---

### Phase 5: フロントエンドUI実装

- [ ] 5. 認証画面の実装
- [ ] 5.1 (P) RegisterFormコンポーネントの実装
  - ユーザー名、メール、パスワードの入力フィールドを作成
  - クライアント側バリデーション（メールフォーマット、パスワード強度チェック）を実装
  - POST /api/auth/register APIを呼び出し
  - 登録成功時にチャット画面へリダイレクト
  - エラーメッセージをフィールド下に表示
  - _Requirements: 1.1_

- [ ] 5.2 (P) LoginFormコンポーネントの実装
  - メール、パスワードの入力フィールドを作成
  - クライアント側バリデーションを実装
  - POST /api/auth/login APIを呼び出し
  - ログイン成功時にチャット画面へリダイレクト
  - ログイン失敗時にエラーメッセージを表示
  - _Requirements: 1.2, 1.3_

- [ ] 5.3 (P) ログアウト機能の実装
  - LogoutButtonコンポーネントを作成
  - POST /api/auth/logout APIを呼び出し
  - セッション終了後にログイン画面にリダイレクト
  - _Requirements: 1.4_

- [ ] 6. チャット画面UIの実装
- [ ] 6.1 Zustandでグローバル状態管理を構築
  - authStore（currentUser、accessToken）を作成
  - roomsStore（rooms、currentRoom）を作成
  - messagesStore（messages、loading、hasMore）を作成
  - LocalStorageにユーザー情報をキャッシュ
  - _Requirements: なし（インフラストラクチャ）_

- [ ] 6.2 Socket.io Clientの初期化とイベントハンドラ
  - Socket.ioシングルトンクライアントを作成
  - 接続時にHttpOnly Cookieを自動送信（ブラウザのデフォルト動作）
  - message:receiveイベントのハンドラを実装（messagesStoreを更新）
  - room:user-joinedイベントのハンドラを実装
  - 接続エラー時にエラーメッセージを表示
  - 自動再接続を有効化（指数バックオフ: 1秒、2秒、4秒、...、最大30秒）
  - _Requirements: 3.1, 4.3, 7.1, 7.4_

- [ ] 6.3 ChatLayoutコンポーネントの実装
  - レスポンシブレイアウトを作成（サイドバー + メインコンテンツ）
  - TailwindCSSでFlexbox/Gridレイアウトを実装
  - モバイル、タブレット、デスクトップに対応
  - Sidebar、MessageList、MessageInputコンポーネントを配置
  - _Requirements: 5.1, 5.4_

- [ ] 6.4 RoomListコンポーネントの実装
  - GET /api/rooms APIを呼び出してルーム一覧を取得
  - ルーム一覧を左側サイドバーに表示
  - ルーム選択時にcurrentRoomを更新
  - 新規ルーム作成ボタンを表示
  - _Requirements: 4.4, 5.2_

- [ ] 6.5 CreateRoomFormコンポーネントの実装
  - ルーム名入力フィールドを作成
  - POST /api/rooms APIを呼び出してルームを作成
  - 作成成功時にルームリストを更新
  - モーダルまたはインラインフォームとして実装
  - _Requirements: 4.1_

- [ ] 6.6 MessageListコンポーネントの実装
  - GET /api/messages APIを呼び出してメッセージ履歴を取得
  - メッセージを時系列順に表示
  - react-windowで仮想化リストを実装（パフォーマンス最適化）
  - 無限スクロール（Intersection Observer APIで上端検知）を実装
  - 新着メッセージ受信時に自動スクロール（useEffect + scrollIntoView）
  - 送信者名とタイムスタンプを表示
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 6.1, 6.2, 6.3_

- [ ] 6.7 MessageInputコンポーネントの実装
  - メッセージ入力フィールドを作成
  - 送信ボタンをクリック時にSocket.ioで`message:send`イベントを発行
  - 空メッセージの検証（クライアント側）を実施
  - 送信成功時に入力フィールドをクリア
  - 送信失敗時にToastNotificationでエラーを表示
  - 10000文字制限を実施
  - _Requirements: 2.1, 2.2, 2.3, 7.2_

- [ ] 6.8 (P) UserListコンポーネントの実装
  - GET /api/rooms/:id/members APIを呼び出してメンバー一覧を取得
  - 現在参加しているユーザーのリストを表示
  - room:user-joinedイベントでリストを更新
  - _Requirements: 5.3_

- [ ] 6.9 (P) エラー表示コンポーネントの実装
  - ErrorBannerコンポーネントを作成（ページ上部に表示）
  - ToastNotificationコンポーネントを作成（右下に表示、5秒後に自動消失）
  - LoadingSpinnerコンポーネントを作成
  - _Requirements: 1.3, 5.5, 7.2, 7.3_

- [ ] 6.10 React Routerでルーティングを構築
  - /register（RegisterForm）
  - /login（LoginForm）
  - /chat（ChatLayout、認証必須）
  - 未認証時に/loginへリダイレクト
  - 認証済み時に/register、/loginから/chatへリダイレクト
  - _Requirements: 1.2, 1.4_

---

### Phase 6: エラーハンドリングとロギング

- [ ] 7. エラーハンドリングとログ記録の実装
- [ ] 7.1 バックエンドのエラーハンドリングミドルウェア
  - グローバルエラーハンドラミドルウェアを実装
  - 構造化されたエラーレスポンスを返却（`{ error: { type, message, field? } }`）
  - 4xx、5xx、422エラーを適切に処理
  - スタックトレースと関連情報をログに記録
  - _Requirements: 7.3, 7.5_

- [ ] 7.2 バックエンドのロギング設定
  - Winston またはPinoでロガーを設定
  - ログレベル（ERROR、WARN、INFO、DEBUG）を定義
  - すべてのエラーをログに記録
  - パスワードやトークンをログから除外
  - _Requirements: 7.5_

- [ ] 7.3 フロントエンドのエラー処理とリトライ機能
  - APIリクエスト失敗時にエラーメッセージを表示
  - WebSocket接続エラー時に「接続が切断されました。再接続中...」を表示
  - タイムアウトエラーに対してリトライボタンを提供
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

---

### Phase 7: テストとE2E検証

- [ ] 8. 統合テストとE2Eテストの実装
- [ ] 8.1 統合テストの作成
  - ユーザー登録 → ログイン → トークン取得の統合テストを作成
  - トークンリフレッシュの統合テストを作成
  - エラーハンドリング（無効な入力、認証失敗）の統合テストを作成
  - SupertestとSocket.io Clientを使用
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 8.2 E2Eテストの作成
  - 新規ユーザー登録 → ルーム作成 → メッセージ送信のE2Eテストを作成
  - 既存ユーザーログイン → ルーム参加 → メッセージ受信のE2Eテストを作成
  - 複数ユーザー間のリアルタイムメッセージングのE2Eテストを作成
  - ネットワーク切断 → 自動再接続 → メッセージ同期のE2Eテストを作成
  - PlaywrightまたはCypressを使用
  - _Requirements: 1.1, 1.2, 2.1, 3.1, 4.1, 4.3, 7.1, 7.4_

- [ ] 8.3* レスポンシブデザインのE2Eテストを作成
  - モバイル、タブレット、デスクトップの表示確認
  - Playwrightのビューポート設定を使用
  - _Requirements: 5.4_

---

### Phase 8: 最終統合と動作確認

- [ ] 9. システム全体の統合と動作確認
- [ ] 9.1 フロントエンドとバックエンドの統合確認
  - すべてのAPIエンドポイントが正しく動作することを確認
  - WebSocket接続が正しく確立されることを確認
  - メッセージ送受信のエンドツーエンドフローを確認
  - ルーム作成・参加・退出のフローを確認
  - _Requirements: 全要件_

- [ ] 9.2 エラーシナリオの動作確認
  - ネットワーク切断時の再接続を確認
  - 無効なトークンでのアクセス拒否を確認
  - 空メッセージの送信拒否を確認
  - サーバーエラー時のユーザーフレンドリーなエラーメッセージを確認
  - _Requirements: 1.3, 2.3, 7.1, 7.2, 7.3, 7.4_

- [ ] 9.3 パフォーマンスとスケーラビリティの検証
  - 1000ユーザーの同時WebSocket接続をテスト（Artillery または k6を使用）
  - 100メッセージ/秒の送信負荷をテスト
  - メッセージ履歴取得のレスポンスタイム（< 200ms）を検証
  - WebSocket接続確立時間（< 500ms）を検証
  - _Requirements: なし（非機能要件）_

---

## 要件カバレッジマトリックス

| 要件ID | 対応タスク |
|--------|---------|
| 1.1 | 1.3, 2.1, 2.2, 2.4, 5.1, 8.1, 8.2 |
| 1.2 | 1.3, 2.1, 2.2, 2.3, 5.2, 6.10, 8.1, 8.2 |
| 1.3 | 2.1, 2.2, 2.3, 2.4, 5.2, 6.9, 8.1, 9.2 |
| 1.4 | 2.1, 2.2, 2.3, 5.3, 6.10, 8.1 |
| 1.5 | 1.3, 2.1, 2.4 |
| 2.1 | 3.1, 3.3, 3.4, 6.7, 8.2 |
| 2.2 | 3.1, 6.7 |
| 2.3 | 6.7, 9.2 |
| 2.4 | 1.3, 3.1 |
| 2.5 | 1.3, 3.1 |
| 3.1 | 3.1, 3.3, 3.4, 6.2, 6.6, 8.2 |
| 3.2 | 6.6 |
| 3.3 | 3.1, 6.6 |
| 3.4 | 3.1, 6.6 |
| 4.1 | 4.1, 4.2, 4.4, 6.5, 8.2 |
| 4.2 | 4.1, 4.2, 4.4 |
| 4.3 | 4.3, 4.4, 6.2, 8.2 |
| 4.4 | 4.1, 4.2, 4.4, 6.4 |
| 4.5 | 1.3, 4.1 |
| 5.1 | 6.3 |
| 5.2 | 6.4 |
| 5.3 | 6.8 |
| 5.4 | 6.3, 8.3 |
| 5.5 | 6.9 |
| 6.1 | 3.1, 3.2, 3.4, 6.6 |
| 6.2 | 3.1, 3.2, 6.6 |
| 6.3 | 3.1, 3.2, 6.6 |
| 6.4 | 1.3, 3.1 |
| 7.1 | 3.3, 6.2, 7.3, 8.2, 9.2 |
| 7.2 | 6.7, 6.9, 7.3, 9.2 |
| 7.3 | 6.9, 7.1, 7.3, 9.2 |
| 7.4 | 3.3, 6.2, 7.3, 8.2, 9.2 |
| 7.5 | 7.1, 7.2 |

---

## 実装順序の推奨事項

1. **Phase 1-2を完了**: インフラストラクチャと認証システムを最初に構築し、すべての後続タスクの基盤を確立
2. **Phase 3-4を並行実装**: メッセージング機能とルーム機能は独立しているため、並行して実装可能
3. **Phase 5を段階的に実装**: UIコンポーネントは個別に実装し、統合時に接続を確認
4. **Phase 6-8を最後に実施**: エラーハンドリング、テスト、最終統合は実装完了後に実施

---

## 注意事項

- **`(P)`マーク**: 並行実装が可能なタスクを示します。依存関係がないため、複数の開発者が同時に作業できます。
- **`*`マーク**: オプションのテストタスクを示します。MVP後に実施可能です。
- **要件トレーサビリティ**: 各タスクは対応する要件IDを明記しています。実装時に要件を再確認してください。
- **コンテキスト管理**: `/kiro:spec-impl` 実行前に会話履歴をクリアし、コンテキストを最適化してください。
